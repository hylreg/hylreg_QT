# hylreg_QT 技术设计文档

## 1. 项目概述

### 1.1 目标

基于 **Qt** 实现一个桌面应用，对 [hylreg_hub](https://github.com/.../hylreg_hub) 所描述的 **Git Submodule 中心仓库**进行管理和可视化。用户通过图形界面完成子模块的添加、克隆、更新、删除以及状态查看，无需记忆命令行。

### 1.2 核心场景

- 打开/选择已有的 hub 仓库（包含 `.gitmodules` 的 Git 仓库）
- 查看当前所有子模块列表及其状态（路径、URL、当前 commit、是否已初始化、是否有未提交修改）
- 添加新子模块（输入 URL，指定在 `repos/<名称>` 下的路径）
- 克隆/初始化子模块（全部或勾选部分）
- 更新子模块（到本仓库记录的 commit，或到远端最新）
- 删除子模块（反注册 + 从工作区移除）
- 可视化：子模块列表、状态标识、可选简单依赖/结构示意

---

## 2. 功能需求

### 2.1 仓库层

| 功能 | 说明 | 对应 README 章节 |
|------|------|------------------|
| 打开仓库 | 选择本地已存在的 hub 仓库根目录（含 `.git` 与可选 `.gitmodules`） | 目录结构 |
| 刷新 | 重新读取 `.gitmodules` 与 `git submodule status`，刷新界面 | 查看有哪些子模块 |
| 新建/检出 | 可选：克隆 hub 时使用 `--recurse-submodules`（若后续支持“从 URL 克隆”） | 克隆本仓库 |

### 2.2 子模块列表与状态

| 功能 | 说明 | 对应 README |
|------|------|-------------|
| 列表展示 | 表格或树形：路径、URL、当前 commit（短 hash）、状态（未初始化/已初始化/有修改等） | 查看有哪些子模块、git submodule status |
| 状态来源 | 解析 `.gitmodules` + 执行 `git submodule status`（可后台线程） | 同上 |
| 筛选/排序 | 按路径、状态筛选或排序（可选） | - |

### 2.3 子模块操作

| 操作 | 说明 | 对应命令/README |
|------|------|------------------|
| 添加子模块 | 输入 URL、子模块名（对应 `repos/<名称>`），执行 `git submodule add <url> repos/<名称>`，并提示提交 | 添加子仓库（子模块） |
| 初始化/拉取 | 全部或选中：`git submodule update --init [--recursive] [repos/<名称>]` | 克隆/日常使用 |
| 更新到记录版本 | 选中子模块：`git submodule update --init repos/<名称>` | 只更新指定子模块 |
| 更新到远端最新 | 选中：`git submodule update --remote repos/<名称>`，并提示 `git add` + 提交 | 更新子模块到其远端最新并记录 |
| 删除子模块 | 选中后确认，执行 `git submodule deinit -f repos/<名称>`、`git rm -f repos/<名称>`，可选删除 `.git/modules/repos/<名称>` | 删除子模块 |

### 2.4 可视化

| 内容 | 说明 |
|------|------|
| 主界面 | 左侧或顶部：当前仓库路径；中间：子模块列表（表格）；右侧或底部：操作按钮或当前子模块详情 |
| 状态标识 | 图标或颜色区分：未初始化、已初始化、有未提交修改、与记录 commit 不一致等 |
| 可选扩展 | 简单“结构图”：根仓库 → 各子模块（repos/xxx），不要求复杂 DAG |

---

## 3. 技术选型

### 3.1 开发语言与框架

- **语言**：Python 3.10+
- **GUI 框架**：PyQt6 或 PySide6（统一用 Qt6，便于后续跨平台）
- **包管理**：uv（符合用户规范）

### 3.2 Git 交互方式

- **方案 A（推荐）**：使用 **subprocess** 调用系统已安装的 `git` 命令，与 README 中命令一一对应，行为可预期、易调试。
- **方案 B**：使用 **GitPython** 等库封装 submodule 操作；若需与 README 完全一致，需核对每条命令的等价调用。

建议先采用 **方案 A**，在固定工作目录（即当前打开的 hub 根目录）下执行 `git submodule ...` 等命令，并将标准输出/错误输出捕获后解析或展示在界面（如“输出”面板）。

### 3.3 解析 .gitmodules 与 status

- **`.gitmodules`**：Python 标准库 `configparser` 可解析其格式（`[submodule "path"]`、`path`、`url` 等）。
- **`git submodule status`**：按行解析；行首符号（`-`、`+`、`U` 等）与 commit hash、path 的格式稳定，可用正则或 split 提取。

---

## 4. 架构设计

### 4.1 模块划分

```
hylreg_QT/
├── main.py                 # 入口，启动 QApplication 与主窗口
├── pyproject.toml / uv 配置
├── app/
│   ├── __init__.py
│   ├── main_window.py      # 主窗口：菜单、工具栏、中心 widget 布局
│   ├── repo_selector.py    # 选择/打开 hub 仓库（目录选择框 + 当前路径显示）
│   ├── submodule_table.py  # 子模块列表（QTableWidget 或 QTableView + model）
│   ├── submodule_actions.py# 添加/更新/删除等按钮与逻辑入口
│   ├── output_panel.py     # 显示 git 命令输出的只读文本框
│   └── git_worker.py       # 在后台线程执行 git 命令，发信号带回结果
├── core/
│   ├── __init__.py
│   ├── git_runner.py       # 封装 subprocess 调用 git，解析 .gitmodules、status
│   └── models.py           # 数据类：SubmoduleInfo（path, url, commit, status_flag）
└── docs/
    └── 技术设计文档.md      # 本文档
```

### 4.2 数据流

1. 用户选择仓库路径 → `repo_selector` 通知主窗口 → 调用 `core/git_runner` 读取 `.gitmodules` 并执行 `git submodule status`。
2. 解析结果转为 `SubmoduleInfo` 列表 → 提供给 `submodule_table` 展示。
3. 用户点击“添加/更新/删除”等 → 主窗口或 `submodule_actions` 调用 `git_worker` 在后台执行对应 `git` 命令。
4. `git_worker` 通过 Qt 信号将 stdout/stderr 传到 `output_panel` 显示，并在完成后触发刷新子模块列表。

### 4.3 线程与安全

- 所有 `git` 命令在 **QThread** 或 **QtConcurrent** 中执行，避免阻塞 UI。
- 结果通过 **信号/槽** 回传主线程更新界面；禁止在子线程直接操作 Qt 控件。

---

## 5. 界面草图（简要）

- **顶部**：菜单（文件-打开仓库/退出）、工具栏（打开仓库、刷新、添加子模块）。
- **左侧或第一行**：当前仓库路径（只读 + “浏览”按钮）。
- **中间**：子模块表格（列：路径、URL、当前 commit、状态）；支持多选用于批量更新/删除。
- **右侧或下方**：操作区——添加子模块、初始化选中、更新到记录、更新到远端、删除选中；可选“全部初始化/全部更新”。
- **底部**：输出面板（只读），显示最近执行的 git 命令及其输出。

可视化不强求复杂图表，第一版以“清晰的列表 + 状态 + 操作按钮”为主。

---

## 6. 与 README 的对应关系

| README 内容 | 实现方式 |
|-------------|----------|
| 目录结构 repos/、.gitmodules | 打开仓库时校验目录下存在 `.git`；列表来自 .gitmodules + status |
| 添加子模块 | “添加子模块”对话框 → `git submodule add ...` |
| 克隆含子模块 | 可选：提供“从 URL 克隆”并带 `--recurse-submodules` |
| 拉取本仓库与所有子模块 | “拉取主仓库”+“全部子模块 update --init --recursive” |
| 只拉取/更新指定子模块 | 表格多选 → “初始化选中”/“更新到记录”/“更新到远端” |
| 在子模块里工作 | 可提供“在文件管理器中打开”或“在终端打开”子模块目录 |
| 更新到远端并记录 | “更新到远端”后提示用户提交：add + commit |
| 删除子模块 | “删除子模块”→ deinit + git rm，可选清理 .git/modules |
| 查看子模块 | 列表即“查看”；状态来自 `git submodule status` |

---

## 7. 依赖与环境

- **Python**：3.10+
- **uv**：项目与依赖管理。
- **PyQt6 或 PySide6**：二选一，建议在 `pyproject.toml` 中写为可选依赖组，便于切换。
- **系统**：需已安装 `git`，且能在终端执行 `git submodule` 等命令。

---

## 8. 开发阶段建议

1. **Phase 1**：搭建 Qt 主窗口 + 选择目录 + 解析 `.gitmodules` 与 `git submodule status`，在表格中只读展示子模块列表。
2. **Phase 2**：实现添加、初始化、更新（到记录/到远端）、删除，并与输出面板联动。
3. **Phase 3**：状态图标、错误提示、提交提醒（更新到远端后提示在主仓库 commit）；可选“从 URL 克隆 hub”。
4. **Phase 4**（可选）：简单可视化结构图、设置项（如 git 路径、默认分支名）。

---

## 9. 文档维护

- 本文档随实现迭代更新，新增功能或命令映射请在“与 README 的对应关系”一节补充。
- 若 hylreg_hub 的 README 有更新，需同步调整本技术文档与实现。
